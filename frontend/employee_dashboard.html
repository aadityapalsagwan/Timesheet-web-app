<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Dashboard</title>
    <link rel="stylesheet" href="./CSS/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .navbar {
            width: 100%;
            padding: 15px 5%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            left: 0;
            z-index: 1000;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
        }

        .nav-brand {
            font-size: 22px;
            font-weight: 700;
            color: #111827;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links button {
            margin-left: 15px;
            padding: 8px 20px;
            border: 1px solid #e5e7eb;
            background: transparent;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #4b5563;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-links button:hover {
            border-color: #4f46e5;
            color: #4f46e5;
            background: rgba(79, 70, 229, 0.05);
        }

        .nav-links button:last-child:hover {
            border-color: #ef4444;
            color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }


        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-wrapper {
            position: relative;
            width: 100%;
            max-width: 300px;
        }

        .search-wrapper input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border-radius: 50px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-bottom: 0;
        }

        .search-wrapper input:focus {
            background: #fff;
            border-color: #4f46e5;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 14px;
        }


        @media (max-width: 600px) {
            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .search-wrapper {
                max-width: 100%;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="nav-brand"><i class="fas fa-clock"></i> WorkTrack</div>
        <div class="nav-links">
            <a href="profile.html" style="text-decoration:none; color:#555; font-weight:500;">Profile</a>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <h3><i class="fas fa-plus-circle"></i> New Timesheet Entry</h3>
            <div class="grid-3">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="date">
                </div>
                <div class="form-group">
                    <label>Hours Worked</label>
                    <input type="number" id="hours" placeholder="e.g. 8">
                </div>
                <div class="form-group">
                    <label>Task Description</label>
                    <input type="text" id="desc" placeholder="What did you work on?">
                </div>
            </div>
            <button onclick="submitTimesheet()" class="btn btn-primary btn-sm" style="margin-top:10px;">
                Submit Entry
            </button>
        </div>

        <div class="card" style="padding:0; overflow:hidden;">

            <div class="table-header">
                <h3 style="margin:0; font-size:1.1rem;">History</h3>
                <div class="search-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" onkeyup="handleSearch()" placeholder="Search task or date...">
                </div>
            </div>

            <div class="table-responsive" style="border:none; border-radius:0;">
                <table>
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Task Description</th>
                            <th>Hours</th>
                            <th>Status / Rating</th>
                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody id="list">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Edit Entry</h3>
            <input type="hidden" id="edit-id">
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="edit-date">
            </div>
            <div class="form-group">
                <label>Hours</label>
                <input type="number" id="edit-hours">
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="edit-desc">
            </div>
            <button onclick="updateTimesheet()" class="btn btn-primary">Update</button>
        </div>
    </div>

    <script>
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || user.role !== 'employee') window.location.href = 'index.html';


        let globalData = [];


        async function loadData() {
            try {
                const res = await fetch(`http://localhost:5000/api/employee/${user._id}`);
                globalData = await res.json();
                renderTable(globalData);
            } catch (err) {
                console.error(err);
            }
        }

        function handleSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();

            const filteredData = globalData.filter(item =>
                item.description.toLowerCase().includes(query) ||
                item.date.includes(query)
            );

            renderTable(filteredData);
        }

        function renderTable(data) {
            const list = document.getElementById('list');

            if (data.length === 0) {
                list.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#888;">No records found.</td></tr>';
                return;
            }

            list.innerHTML = data.map(t => {
                const isLocked = t.isLocked;
                return `
                <tr style="animation: fadeIn 0.3s ease;">
                    <td>
                        <div style="font-weight:600;">${t.date}</div>
                        <div style="font-size:0.8rem; color:var(--text-light);">${t.timestamp}</div>
                    </td>
                    <td>${t.description}</td>
                    <td><span class="badge badge-locked">${t.hours} hrs</span></td>
                    <td>
                        ${t.rating
                        ? `<span class="star" style="color:#fbbf24;">${'â˜…'.repeat(t.rating)}</span> <br><small style="color:var(--text-light)">by ${t.ratedBy}</small>`
                        : `<span class="badge badge-pending">Pending</span>`
                    }
                    </td>
                    <td>
                        ${isLocked
                        ? `<button class="btn btn-sm btn-secondary" disabled style="opacity:0.5; cursor:not-allowed;"><i class="fas fa-lock"></i></button>`
                        : `<button onclick='openEditModal(${JSON.stringify(t)})' class="btn btn-sm btn-primary"><i class="fas fa-pen"></i></button>`
                    }
                    </td>
                    <td>
                        ${isLocked
                        ? `<button class="btn btn-sm btn-secondary" disabled><i class="fas fa-lock"></i></button>`
                        : `<button onclick="deleteTimesheet('${t._id}')" class="btn btn-sm btn-danger" style="color: red; background:rgba(255,0,0,0.1);"><i class="fas fa-trash"></i></button>`
                    }
                    </td>
                </tr>
            `}).join('');
        }

        async function submitTimesheet() {
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            await fetch('http://localhost:5000/api/employee/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    employeeId: user._id,
                    employeeName: user.name,
                    date: document.getElementById('date').value,
                    timestamp: time,
                    hours: document.getElementById('hours').value,
                    description: document.getElementById('desc').value
                })
            });
            document.getElementById('desc').value = '';
            document.getElementById('hours').value = '';
            loadData();
        }

        function openEditModal(item) {
            document.getElementById('edit-id').value = item._id;
            document.getElementById('edit-date').value = item.date;
            document.getElementById('edit-hours').value = item.hours;
            document.getElementById('edit-desc').value = item.description;
            document.getElementById('editModal').style.display = 'block';
        }

        async function updateTimesheet() {
            const id = document.getElementById('edit-id').value;
            await fetch(`http://localhost:5000/api/employee/edit/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    date: document.getElementById('edit-date').value,
                    hours: document.getElementById('edit-hours').value,
                    description: document.getElementById('edit-desc').value
                })
            });
            closeModal();
            loadData();
        }

        async function deleteTimesheet(id) {
            if (!confirm('Delete this entry?')) return;
            await fetch(`http://localhost:5000/api/employee/delete/${id}`, { method: 'DELETE' });
            loadData();
        }

        function closeModal() { document.getElementById('editModal').style.display = 'none'; }
        function logout() { localStorage.removeItem('user'); window.location.href = 'index.html'; }

        document.getElementById('date').valueAsDate = new Date();
        loadData();
    </script>
</body>

</html>